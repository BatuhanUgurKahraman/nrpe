###############################
# Makefile for NRPE
#
# Last Modified: 03-14-2007
###############################


# Source code directories
SRC_BASE=./src/
SRC_INCLUDE=./include/

CC=@CC@
CFLAGS=@CFLAGS@ @DEFS@
LDFLAGS=@LDFLAGS@ @LIBS@

prefix=@prefix@
exec_prefix=@exec_prefix@
CFGDIR=@pkgsysconfdir@
BINDIR=@bindir@
SBINDIR=@sbindir@
LIBEXECDIR=@libexecdir@
INSTALL=@INSTALL@
NAGIOS_INSTALL_OPTS=@NAGIOS_INSTALL_OPTS@
NRPE_INSTALL_OPTS=@NRPE_INSTALL_OPTS@
OPSYS=@opsys@
DIST=@dist_type@
USERID=@nrpe_user@
GRPID=@nrpe_group@

INIT_TYPE=@init_type@
INIT_DIR=@initdir@
INIT_OPTS=-o root -g root
INIT_FILE=@initname@
INETD_TYPE=@inetd_type@
INETD_DIR=@inetddir@
INETD_FILE=@inetdname@
SRC_INETD=@src_inetd@
SRC_INIT=@src_init@


default:
	@echo;\
	echo Please enter 'make [option]' where [option] is one of:;\
	echo;\
	echo "     all                builds nrpe and check_nrpe";\
	echo "     nrpe               builds nrpe only";\
	echo "     check_nrpe         builds check_nrpe only";\
	echo "     install            install nrpe and check_nrpe";\
	echo "     install-plugin     install the check_nrpe plugin";\
	echo "     install-daemon     install the nrpe daemon";\
	echo "     install-group      add the $GRPID group id if it does not exist";\
	echo "     install-user       add the $USERID user id if it does not exist";\
	echo "     install-group-user add the $USERID user and $GRPID group";\
	echo "     install-config     install the nrpe configuration file";\
	echo "     install-inetd      install the startup files for inetd, launchd, etc.";\
	echo "     install-init       install the startup files for init, systemd, etc.";\
	echo "     solaris-package    create the solaris package";\
	echo

all:
	cd $(SRC_BASE); $(MAKE)

	@echo "";\
	echo "*** Compile finished ***";\
	echo "";\
	echo "If the NRPE daemon and client compiled without any errors, you";\
	echo "can continue with the installation or upgrade process.";\
	echo "";\
	echo "Read the PDF documentation (NRPE.pdf) for information on the next";\
	echo "steps you should take to complete the installation or upgrade.";\
	echo ""

nrpe:
	cd $(SRC_BASE); $(MAKE)

check_nrpe:
	cd $(SRC_BASE); $(MAKE)

install-plugin:
	cd $(SRC_BASE); $(MAKE) $@

install-daemon:
	cd $(SRC_BASE); $(MAKE) $@

install:
	cd $(SRC_BASE); $(MAKE) $@

install-inetd:
	@if test $(SRC_INETD) = unknown; then \
		echo No inetd file to install; \
		exit 1; \
	fi
	@if test $(INETD_TYPE) = inetd; then \
		grep -E -q "^\W*nrpe\s+" $(INETD_DIR)/$(INETD_FILE) || \
		   cat startup/$(SRC_INETD) >> $(INETD_DIR)/$(INETD_FILE); \
	else \
		echo $(INSTALL) -m 644 startup/$(SRC_INETD) $(INETD_DIR)/$(INETD_FILE); \
		$(INSTALL) -m 644 startup/$(SRC_INETD) $(INETD_DIR)/$(INETD_FILE); \
		if test $(INETD_TYPE) = systemd; then \
			SRC_INETD_FILE=`echo "$(SRC_INETD)" | sed -e 's/socket/socket-svc/'`; \
			echo $(INSTALL) -m 644 startup/$$SRC_INETD_FILE $(INETD_DIR)/$(INIT_FILE); \
			$(INSTALL) -m 644 startup/$$SRC_INETD_FILE $(INETD_DIR)/$(INIT_FILE); \
		fi; \
	fi
	@grep -E -q "^nrpe[\t ]+5666/tcp" /etc/services || \
		echo "***** MAKE SURE 'nrpe 5666/tcp' IS IN YOUR /etc/services FILE"

install-init:
	@if test $(SRC_INIT) = unknown; then \
		echo No init file to install; \
		exit 1; \
	fi
	@if test $(INIT_TYPE) = upstart; then\
		echo $(INSTALL) -m 644 startup/$(SRC_INIT) $(INIT_DIR)/$(INIT_FILE); \
		$(INSTALL) -m 644 startup/$(SRC_INIT) $(INIT_DIR)/$(INIT_FILE); \
		echo initctl reload-configuration; \
		initctl reload-configuration; \
	elif test $(INIT_TYPE) = systemd; then\
		echo $(INSTALL) -m 644 startup/$(SRC_INIT) $(INIT_DIR)/$(INIT_FILE); \
		$(INSTALL) -m 644 startup/$(SRC_INIT) $(INIT_DIR)/$(INIT_FILE); \
	else\
		echo $(INSTALL) -m 755 startup/$(SRC_INIT) $(INIT_DIR)/$(INIT_FILE); \
		$(INSTALL) -m 755 startup/$(SRC_INIT) $(INIT_DIR)/$(INIT_FILE); \
	fi

install-config:
	$(INSTALL) -m 775 $(NAGIOS_INSTALL_OPTS) -d $(CFGDIR)
	$(INSTALL) -m 644 $(NRPE_INSTALL_OPTS) sample-config/nrpe.cfg $(CFGDIR)

install-group:
	@if test $(OPSYS) = aix; then\
		mkgroup $(GRPID);\
	elif test $(OPSYS) = hpux -o $(OPSYS) = solaris; then\
		groupadd $(GRPID);\
	elif test $(OPSYS) = osx; then\
		newid=`dscl . -list /Groups gid | tr -s ' ' | cut -d' ' -f2 | sort -n | tail -1`;\
		newid=`expr 1 + $newid`;\
		dscl . -create /Groups/$(GRPID) gid $$newid;\
	elif test $(OPSYS) = "bsd" -a $(DIST) = "freebsd"; then\
		pw add group $(GRPID);\
	else\
		groupadd -r $(GRPID);\
	fi

install-user:
	@if test $(OPSYS) = aix; then\
		useradd -g $(GRPID) $(USERID);\
	elif test $(OPSYS) = hpux -o $(OPSYS) = solaris; then\
		useradd -g $(GRPID) $(USERID);\
	elif test $(OPSYS) = osx; then\
		newid=`dscl . -list /Users UniqueID | tr -s ' ' | cut -d' ' -f2 | sort -n | tail -1`;\
		newid=`expr 1 + $newid`;\
		dscl . -create /Users/$(USERID);\
		dscl . -create /Users/$(USERID) UniqueID $$newid;\
		dscl . -append /Groups/$(GRPID) GroupMembership $(USERID);\
	elif test $(OPSYS) = "bsd" -a $(DIST) = "freebsd"; then\
		pw add user -g $(GRPID) $(USERID);\
	else\
		useradd -r -g $(GRPID) $(USERID);\
	fi

install-group-user:
	$(MAKE) install-group
	$(MAKE) install-user


solaris-package:
	@if [ `uname -s` != "SunOS" ] ; then \
		echo "It is recommended you be running on Solaris to build a Solaris package"; \
	else \
		cd package/solaris; $(MAKE) build ; $(MAKE) pkg ; cd ../..; \
	fi

clean:
	cd $(SRC_BASE); $(MAKE) $@; cd ..
	cd package/solaris; $(MAKE) $@; cd ../..
	rm -f core
	rm -f *~ */*~

distclean: clean
	cd $(SRC_BASE); $(MAKE) $@; cd ..
	cd package/solaris; $(MAKE) $@; cd ../..
	rm -rf autom4te.cache
	rm -f config.log config.status config.cache sample-config/nrpe.cfg $(SRC_INCLUDE)/config.h
	rm -f startup/bsd-init startup/debian-init startup/default-init startup/default-inetd
	rm -f startup/default-service startup/default-xinetd startup/mac-org.nagios.PKG_NAME.plist
	rm -f startup/openrc-conf startup/openrc-init startup/solaris-PKG_NAME.xml
	rm -f Makefile

devclean: distclean

